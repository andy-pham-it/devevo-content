name: Validate Content

on:
  pull_request:
    paths:
      - "quiz/**"
      - "explore/**"
      - "videos/**"
  push:
    branches:
      - main
    paths:
      - "quiz/**"
      - "explore/**"
      - "videos/**"

jobs:
  validate-json:
    name: Validate JSON Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Validate all JSON files
        run: |
          echo "üîç Validating JSON files..."
          find . -name "*.json" -type f | while read file; do
            echo "Checking: $file"
            if ! node -e "JSON.parse(require('fs').readFileSync('$file', 'utf8'))"; then
              echo "‚ùå Invalid JSON: $file"
              exit 1
            fi
          done
          echo "‚úÖ All JSON files are valid!"

      - name: Validate quiz metadata
        run: |
          echo "üîç Validating quiz/meta.json structure..."
          node -e "
            const meta = JSON.parse(require('fs').readFileSync('quiz/meta.json', 'utf8'));
            if (!meta.version || !meta.topics || !Array.isArray(meta.topics)) {
              console.error('‚ùå Invalid quiz/meta.json structure');
              process.exit(1);
            }
            console.log('‚úÖ quiz/meta.json structure is valid!');
            console.log('üìä Total topics:', meta.topics.length);
          "

      - name: Validate explore metadata
        run: |
          echo "üîç Validating explore/meta.json structure..."
          node -e "
            const meta = JSON.parse(require('fs').readFileSync('explore/meta.json', 'utf8'));
            if (!meta.version || !meta.resources || !Array.isArray(meta.resources)) {
              console.error('‚ùå Invalid explore/meta.json structure');
              process.exit(1);
            }
            console.log('‚úÖ explore/meta.json structure is valid!');
            console.log('üìä Total resources:', meta.resources.length);
          "

      - name: Validate videos metadata
        run: |
          echo "üîç Validating videos/meta.json structure..."
          node -e "
            const meta = JSON.parse(require('fs').readFileSync('videos/meta.json', 'utf8'));
            if (!meta.categories || !meta.videos || !Array.isArray(meta.videos)) {
              console.error('‚ùå Invalid videos/meta.json structure');
              process.exit(1);
            }
            console.log('‚úÖ videos/meta.json structure is valid!');
            console.log('üìä Total videos:', meta.videos.length);
          "

  validate-markdown:
    name: Validate Markdown Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install markdownlint
        run: npm install -g markdownlint-cli

      - name: Lint markdown files
        run: |
          echo "üîç Linting markdown files..."
          markdownlint 'explore/sources/**/*.md' --config .markdownlint.json || true
          echo "‚úÖ Markdown linting complete!"

      - name: Check markdown file references
        run: |
          echo "üîç Checking if all referenced markdown files exist..."
          node -e "
            const meta = JSON.parse(require('fs').readFileSync('explore/meta.json', 'utf8'));
            const fs = require('fs');
            let allExist = true;
            
            meta.resources.forEach(resource => {
              const path = 'explore/' + resource.filePath;
              if (!fs.existsSync(path)) {
                console.error('‚ùå Missing file:', path);
                allExist = false;
              }
            });
            
            if (!allExist) {
              process.exit(1);
            }
            console.log('‚úÖ All markdown files exist!');
          "

  validate-quiz-files:
    name: Validate Quiz Question Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Check quiz file references
        run: |
          echo "üîç Checking if all referenced quiz files exist..."
          node -e "
            const meta = JSON.parse(require('fs').readFileSync('quiz/meta.json', 'utf8'));
            const fs = require('fs');
            let allExist = true;
            let totalQuestions = 0;
            
            meta.topics.forEach(topic => {
              const path = 'quiz/' + topic.filePath;
              if (!fs.existsSync(path)) {
                console.error('‚ùå Missing file:', path);
                allExist = false;
              } else {
                const questions = JSON.parse(fs.readFileSync(path, 'utf8'));
                totalQuestions += questions.length;
                console.log('‚úÖ', topic.name + ':', questions.length, 'questions');
              }
            });
            
            if (!allExist) {
              process.exit(1);
            }
            console.log('\\nüìä Total questions across all topics:', totalQuestions);
          "

      - name: Validate quiz question structure
        run: |
          echo "üîç Validating quiz question structure..."
          node -e "
            const meta = JSON.parse(require('fs').readFileSync('quiz/meta.json', 'utf8'));
            const fs = require('fs');
            let isValid = true;
            
            meta.topics.forEach(topic => {
              const path = 'quiz/' + topic.filePath;
              if (fs.existsSync(path)) {
                const questions = JSON.parse(fs.readFileSync(path, 'utf8'));
                
                questions.forEach((q, index) => {
                  // Support both formats:
                  // Format 1: question + correctAnswer (old)
                  // Format 2: questionText + correctAnswerIndex (new)
                  const hasQuestion = q.question || q.questionText;
                  const hasCorrectAnswer = q.correctAnswer !== undefined || q.correctAnswerIndex !== undefined;
                  
                  // Check required fields
                  if (!q.id || !hasQuestion || !q.options || !q.explanation) {
                    console.error('‚ùå Invalid question structure in', path, 'at index', index);
                    console.error('   Missing: id, question/questionText, options, or explanation');
                    isValid = false;
                  }
                  
                  // Check options array
                  if (!Array.isArray(q.options) || q.options.length < 2) {
                    console.error('‚ùå Invalid options in', path, 'at index', index);
                    console.error('   Options must be an array with at least 2 items');
                    isValid = false;
                  }
                  
                  // Check correctAnswer/correctAnswerIndex
                  if (!hasCorrectAnswer) {
                    console.error('‚ùå Missing correctAnswer/correctAnswerIndex in', path, 'at index', index);
                    isValid = false;
                  } else {
                    const correctField = q.correctAnswerIndex !== undefined ? q.correctAnswerIndex : q.correctAnswer;
                    if (typeof correctField !== 'number' || correctField < 0 || correctField >= q.options.length) {
                      console.error('‚ùå Invalid correctAnswer in', path, 'at index', index);
                      console.error('   Expected: number between 0 and', q.options.length - 1, ', got:', correctField);
                      isValid = false;
                    }
                  }
                });
              }
            });
            
            if (!isValid) {
              process.exit(1);
            }
            console.log('‚úÖ All quiz questions have valid structure!');
          "

  content-stats:
    name: Generate Content Statistics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Generate statistics
        run: |
          echo "üìä Content Statistics"
          echo "===================="
          echo ""

          # Quiz stats
          QUIZ_TOPICS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('quiz/meta.json', 'utf8')).topics.length)")
          echo "Quiz Topics: $QUIZ_TOPICS"

          # Explore stats
          EXPLORE_RESOURCES=$(node -e "console.log(JSON.parse(require('fs').readFileSync('explore/meta.json', 'utf8')).resources.length)")
          echo "Explore Resources: $EXPLORE_RESOURCES"

          # Video stats
          VIDEOS=$(node -e "console.log(JSON.parse(require('fs').readFileSync('videos/meta.json', 'utf8')).videos.length)")
          echo "Videos: $VIDEOS"

          echo ""
          echo "‚úÖ Content validation complete!"
